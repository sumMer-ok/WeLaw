# EnofLaw 更新日志

## 2026-02-23

### 笔记库模块 - 评论功能重构（与案例模块统一）

#### 重构内容

1. **评论卡片结构重构**
   - 添加评论卡片头部，显示引用原文，支持点击展开/收起
   - 添加展开/收起图标（ArrowDown/ArrowUp）
   - 新增 `expandedCommentIds` 数组管理展开状态
   - 点击评论头部自动定位到正文对应高亮位置

2. **评论内容支持Markdown渲染**
   - 引入 `marked` 库解析Markdown
   - 添加 `renderMarkdown` 函数处理评论内容
   - 支持段落、代码块、行内代码等Markdown语法
   - 回复内容同样支持Markdown渲染

3. **评论操作方式优化**
   - 评论操作改为下拉菜单形式（编辑/删除）
   - 新增点赞功能，显示点赞数量
   - 添加 `likeComment` 方法处理点赞
   - 添加 `handleCommentAction` 方法统一处理评论操作

4. **回复编辑功能增强**
   - 回复编辑支持图片拖拽和粘贴
   - 添加 `handleReplyEditImageDrop` 处理拖拽图片
   - 添加 `handleReplyEditImagePaste` 处理粘贴图片
   - 添加 `removeReplyEditImage` 移除编辑中的图片
   - 修改 `editReply` 方法使用新的数据结构
   - 修改 `saveReplyEdit` 方法保存图片

5. **评论排序功能**
   - 添加 `sortedComments` 计算属性
   - 评论按照在文档中出现的顺序排列（与左侧文本顺序一致）
   - 优先根据编辑器中评论标记的顺序排序
   - 不在文档中的评论按创建时间倒序排列

6. **图片查看功能优化**
   - 重写 `viewImage` 方法，使用全屏遮罩查看图片
   - 添加 `showImageContextMenu` 方法显示右键菜单
   - 添加 `copyImageToClipboard` 方法复制图片到剪贴板
   - 支持"复制图片"和"在新窗口打开"操作

7. **新增依赖和导入**
   - 添加 `marked` 库导入
   - 添加 `CircleCheck`、`ArrowUp`、`More` 图标导入

8. **样式全面更新**
   - 重构 `.comment-card` 样式，支持展开/收起动画
   - 新增 `.comment-card-header` 样式
   - 新增 `.comment-card-body` 样式
   - 更新 `.comment-content` 支持Markdown渲染样式
   - 更新 `.comment-actions-bar` 样式
   - 更新回复编辑区域样式，添加图片预览
   - 统一图片缩略图样式 `.image-thumbnail`

9. **点击评论标记跳转修复**
   - 添加 `handleEditorClick` 方法处理编辑器点击事件
   - 点击评论标记时自动打开评论面板
   - 自动展开对应评论卡片
   - 自动滚动到评论区对应位置
   - 同时高亮原文中的评论标记

10. **Markdown渲染修复**
    - 修改 `renderMarkdown` 函数为箭头函数，与案例模块保持一致
    - 使用 `marked.parse(content, { breaks: true, gfm: true })` 方式调用
    - 添加错误处理，渲染失败时返回原文

11. **Markdown样式完善**
    - 为 `.comment-content` 添加完整的Markdown元素样式支持：
      - 标题样式（h1-h6）：不同字号和字重
      - 列表样式（ul、ol、li）：缩进和间距
      - 强调样式（strong、em）：粗体和斜体
      - 引用样式（blockquote）：左边框和颜色
      - 链接样式（a）：主色和悬停效果
      - 分隔线样式（hr）：边框样式
    - 为 `.reply-content` 同样添加完整的Markdown样式支持
    - 使用 `:deep()` 选择器确保样式穿透到渲染的HTML

12. **飞书风格即时渲染编辑器**
    - 添加 `handleMarkdownShortcut` 函数处理 Markdown 快捷语法
    - 添加 `handleEditorKeyup` 函数监听按键抬起事件
    - 支持输入 `# ` 后自动转换为一级标题
    - 支持输入 `## ` 后自动转换为二级标题
    - 支持输入 `### ` 后自动转换为三级标题
    - 支持输入 `- ` 或 `* ` 后自动转换为无序列表
    - 支持输入 `1. ` 后自动转换为有序列表
    - 支持输入 `> ` 后自动转换为引用块
    - 添加 `convertToHeading` 函数转换标题
    - 添加 `convertToList` 函数转换列表
    - 添加 `convertToQuote` 函数转换引用
    - 添加 `handleEnterKey` 函数处理标题后的回车
    - 修复：使用 `keyup` 事件替代 `keydown`，确保空格已输入到 DOM 后再检测
    - 修复：为转换后的标题、列表、引用元素添加 `contentEditable = 'true'`，确保可继续编辑

13. **左侧目录大纲功能**
    - 添加 `outlineItems` 响应式数组存储目录项
    - 添加 `showOutlinePanel` 控制目录面板显示
    - 添加 `activeOutlineId` 记录当前激活的目录项
    - 添加 `updateOutline` 函数扫描编辑器中的标题生成目录
    - 添加 `scrollToHeading` 函数点击目录跳转对应位置
    - 添加 `handleEditorScroll` 函数监听滚动更新当前目录项
    - 在工具栏添加目录按钮控制面板显示/隐藏
    - 添加 `.outline-panel` 样式：固定宽度220px，可滚动列表
    - 添加 `.outline-item` 样式：不同层级缩进，悬停和激活效果
    - 目录项根据标题层级（h1-h6）显示不同缩进

14. **目录定时监控与自动更新功能**
    - 添加 `outlineUpdateTimer` 定时器变量
    - 添加 `startOutlineTimer` 函数启动定时更新（每3秒）
    - 添加 `stopOutlineTimer` 函数停止定时更新
    - 修改 `updateOutline` 函数：
      - 复用已有标题ID，避免频繁重绘
      - 添加变化检测逻辑，只有目录内容变化时才更新
      - 使用 JSON.stringify 比较前后目录差异
    - 在 `onMounted` 中启动定时器
    - 在 `onUnmounted` 中停止定时器
    - 确保文档内容变化（添加、修改、删除标题）时目录自动同步

15. **全屏编辑功能**
    - 添加 `isFullscreen` 响应式变量记录全屏状态
    - 添加 `toggleFullscreen` 函数切换全屏模式
    - 添加 `isFullscreen` 响应式变量控制全屏状态
    - 在工具栏添加全屏按钮（FullScreen 图标）
    - 全屏按钮根据状态显示不同样式（激活时为 primary 类型）
    - 为 `.note-editor-panel` 添加 `is-fullscreen` 类样式
    - 全屏模式下编辑器固定定位覆盖整个视口（position: fixed; top: 0; left: 0; right: 0; bottom: 0;）
    - 全屏模式下编辑器内容区域自适应高度（calc(100vh - 120px)）
    - 导入 `FullScreen` 图标
    - 修复：改为编辑区域全屏，而非浏览器全屏

---

## 2026-02-23

### 笔记库模块 - 选中文本工具栏修复（彻底修复版）

#### 修复

1. **选中文本工具栏右侧图标间隔修复**
   - 将工具栏 `gap` 从 5px 增加到 8px
   - 为 `.format-btn` 类添加 `margin: 0 4px` 使右侧图标间隔更宽松
   - 解决图标过于紧凑的问题

2. **格式按钮点击问题彻底修复**
   - 将格式按钮从 `div` 改为 `el-button` 组件
   - 移除 `@click.stop` 修饰符，使用 `el-button` 原生点击事件
   - 修复 `formatSelection` 函数，确保在应用格式前先恢复选区
   - 添加 `selection.rangeCount === 0` 检查，防止空选区导致错误

3. **悬停和点击动画效果修复**
   - 为 `.format-btn` 类添加 `!important` 确保动画效果优先应用
   - 悬停效果：`transform: scale(1.05)`
   - 点击效果：`transform: scale(0.95)`
   - 统一悬停背景色为 `#f0f0f0`

4. **样式覆盖修复**
   - 添加 `border: none !important` 移除按钮边框
   - 添加 `.el-button.text` 样式覆盖默认按钮样式

5. **SVG图标动画统一**
   - 为 `.format-icon-svg` 类添加 `transition: transform 0.2s ease`
   - 添加 `&:hover .format-icon-svg` 规则，悬停时 `transform: scale(1.1)`
   - 确保SVG图标与其他图标动画保持一致

6. **SVG图标悬停动画修复**
   - 将 `.format-icon-svg` 从 `el-icon` 组件改为直接使用图标组件
   - 添加 `width: 16px; height: 16px;` 确保图标尺寸正确
   - 添加 `!important` 确保动画效果不被覆盖
   - 修复后SVG图标现在可以正常显示悬停放大动画效果

7. **图标显示和动画最终修复**
   - 修复链接和复制图标无法显示的问题，将图标改回使用 `el-icon` 包裹
   - 修复评论按钮，统一使用 `el-button` 组件并添加 `format-btn` 类
   - 更新CSS样式，确保 `el-icon` 内的SVG图标也能正确显示悬停动画
   - 为 `.format-icon-svg` 内的 `svg` 元素添加独立的过渡动画
   - 确保所有图标（链接、复制、评论）悬停时都有放大动画效果

8. **评论图标显示修复**
   - 修复评论图标无法显示的问题
   - 将评论图标从 `<ChatDotRound class="format-icon-svg" />` 改为 `<el-icon class="format-icon-svg"><ChatDotRound /></el-icon>`
   - 确保评论图标与其他SVG图标显示方式一致

#### 优化

3. **图标位置交换**
   - 交换复制图标和翻译图标的位置，翻译在前，复制在后
   - 保持与其他功能按钮的一致性

4. **翻译功能增强**
   - 添加翻译弹窗组件，与案例模块保持一致
   - 添加 `showTranslationPopup`、`translationPosition`、`translatedText` 状态变量
   - 更新 `translateSelection` 函数，显示翻译弹窗而非消息提示
   - 添加翻译弹窗样式：固定定位、白色背景、圆角阴影、原文/译文分区显示

---

## 2026-02-24

### 笔记库模块 - 标签管理功能增强

#### 新增功能

1. **标签管理对话框**
   - 添加 `showTagManager` 响应式变量控制对话框显示
   - 添加 `tagSearchQuery` 搜索关键词变量
   - 添加 `selectedTags` 数组存储已选中的标签ID（支持多选）
   - 添加 `tagManagerActiveTab` 控制当前标签页
   - 使用 `el-dialog` 组件实现标签管理对话框

2. **标签管理功能实现**
   - 添加 `openTagManager` 函数：打开对话框并初始化已选标签
   - 添加 `closeTagManager` 函数：关闭对话框并清空状态
   - 添加 `saveTagChanges` 函数：保存标签更改到当前笔记
   - 添加 `toggleTagSelection` 函数：切换标签选中状态（支持多选）
   - 添加 `createNewTag` 函数：创建新标签并自动选中
   - 添加 `deleteTag` 函数：删除标签并从所有笔记中移除
   - 添加 `filteredTags` 计算属性：根据搜索关键词过滤标签
   - 添加 `currentNoteTags` 计算属性：获取当前笔记的标签列表

3. **标签搜索框样式**
   - 搜索框文字颜色设为黑色：`color: #000000 !important`
   - 使用 `:deep(.el-input__inner)` 穿透样式
   - 添加搜索框背景色：`background: $bg-secondary`

4. **标签多选功能**
   - 点击标签切换选中状态
   - 已选标签显示选中样式（背景色+边框）
   - 显示勾选图标标识已选标签
   - 底部显示已选标签预览区域
   - 已选标签可点击关闭按钮移除

5. **标签管理对话框样式**
   - 添加 `.tag-manager-content` 容器样式
   - 添加 `.tag-search-box` 搜索框区域样式
   - 添加 `.tag-list-section` 标签列表区域样式
   - 添加 `.tag-select-item` 标签项样式：
     - 悬停效果：`background: $bg-secondary`
     - 选中效果：`background: rgba($primary, 0.1)` + 边框
     - 颜色圆点、标签名、使用次数、勾选图标、删除按钮布局
   - 添加 `.tag-delete-btn` 删除按钮样式：
     - 默认隐藏，悬停显示
     - 悬停时变为红色
   - 添加 `.selected-tags-preview` 已选标签预览区域样式
   - 添加 `.tag-manager-footer` 底部按钮区域样式

---

## 2026-02-23

### 项目文档 - 新增项目介绍说明

#### 新增

1. **项目介绍文档**
   - 创建 `documents/init/project_introduction.md` 项目介绍说明文档
   - 包含项目概述、核心功能、技术栈、系统架构、目标用户、项目特色、开发阶段规划等内容
   - 基于详细设计文档整理生成，便于快速了解项目全貌

---

## 2026-02-23

### 笔记库模块 - 工具栏与评论功能完善

#### 修复与优化

1. **侧边栏打开顺序控制**
   - 实现笔记库栏和笔记列表栏的打开顺序控制
   - 当两个栏都收缩时，必须先打开笔记库栏才能打开笔记列表栏
   - 添加 `toggleNotesList()` 和 `toggleFolderSidebar()` 函数实现逻辑控制

2. **选中文本工具栏格式按钮修复**
   - 修复 `formatSelection` 函数，保存并恢复选区
   - 加粗、斜体、下划线、删除线按钮现在可以正常点击并应用格式
   - 格式按钮添加激活状态显示（active 类）

3. **工具栏间距与样式优化**
   - 右侧工具栏图标间距统一调整为 5px
   - 添加悬停动画效果：scale(1.05) 放大和 scale(0.95) 点击效果
   - 使用 cubic-bezier 曲线优化动画流畅度
   - 按钮尺寸统一为 28x28px

4. **工具栏图标与功能**
   - 添加复制功能按钮，使用 `DocumentCopy` 图标
   - 翻译按钮改为文字"译"样式
   - 统一所有格式按钮的样式类 `.format-btn`
   - 添加 `.format-icon` 和 `.format-icon-svg` 统一样式

5. **评论区背景优化**
   - 评论面板背景改为纯白色 `#ffffff`
   - 评论列表背景改为纯白色 `#ffffff`
   - 评论卡片背景改为纯白色 `#ffffff`

#### 新增功能

6. **评论编辑功能**
   - 评论内联编辑：点击编辑按钮显示输入框
   - 支持取消和保存操作
   - 编辑时隐藏评论操作按钮
   - 保存后自动更新评论内容和修改时间

7. **回复编辑功能**
   - 回复内联编辑：与评论编辑一致
   - 支持取消和保存操作
   - 编辑时隐藏回复操作按钮
   - 保存后自动更新回复内容

8. **笔记列表收缩功能**
   - 添加收缩按钮，位于笔记列表左侧边缘
   - 点击按钮可收起/展开笔记列表
   - 收起后显示为窄条，保留展开按钮
   - 添加平滑过渡动画效果
   - 收起状态下按钮位置自适应调整

---

## 2026-02-23

### 笔记库模块 - 工具栏优化与评论编辑功能

#### 修复

1. **字体颜色按钮点击功能**
   - 修复 `formatText` 函数参数传递问题，支持传入颜色值
   - 添加 `@click.stop` 阻止事件冒泡，确保下拉菜单正常展开
   - 颜色选择器点击事件添加 `.stop` 修饰符

2. **工具栏右侧按钮点击功能**
   - 添加缺失的 `insertCheckbox` 函数，实现待办事项插入
   - 修复复选框、链接、图片、表格、代码等按钮的点击事件

3. **工具栏间距优化（参考飞书样式）**
   - 整体内边距：`6px` → `8px 12px`
   - 按钮间距：`4px` → `8px`
   - 分隔符边距：`4px` → `8px`
   - 工具栏背景色改为 `#fafafa`
   - 按钮组之间添加右边框分隔线
   - 按钮悬停效果优化，添加过渡动画

#### 新增功能

4. **评论编辑功能**
   - 评论内联编辑：点击编辑按钮显示输入框
   - 支持取消和保存操作
   - 编辑时隐藏评论操作按钮
   - 保存后自动更新评论内容和修改时间

5. **回复编辑功能**
   - 回复内联编辑：与评论编辑一致
   - 支持取消和保存操作
   - 编辑时隐藏回复操作按钮
   - 保存后自动更新回复内容

6. **笔记列表收缩功能**
   - 添加收缩按钮，位于笔记列表左侧边缘
   - 点击按钮可收起/展开笔记列表
   - 收起后显示为窄条，保留展开按钮
   - 添加平滑过渡动画效果
   - 收起状态下按钮位置自适应调整

---

## 2026-02-23

### 笔记库模块 - 图标修复与字体颜色功能

#### 修复

1. **图标显示问题**
   - 添加 Element Plus 图标组件导入
   - 修复所有图标无法正常显示的问题
   - 包含图标：Folder, FolderOpened, Plus, Edit, Delete, CollectionTag, Search, ArrowDown, ArrowRight, Fold, Expand, Document, Notebook, ArrowLeft, Share, Download, More, Close, ChatDotRound, Quote, ChatLineRound, Picture, EditPen, Flag, Italic, Underline, DeleteLine, List, Sort, Check, Link, Grid, Code, View, Hide, RefreshRight, ArrowUp

#### 新增功能

2. **字体颜色功能**
   - 编辑器工具栏添加字体颜色按钮
   - 选中文字工具栏添加颜色选项
   - 支持8种常用颜色：黑色、红色、橙色、黄色、绿色、蓝色、紫色、灰色
   - 颜色选择器采用网格布局，悬停放大效果
   - 当前选中的颜色会高亮显示
   - 使用 `document.execCommand('foreColor')` 实现字体颜色设置

---

### 笔记库模块 - 飞书云文档风格即时渲染编辑器

#### 新增功能

1. **Markdown即时渲染编辑器（飞书云文档风格）**
   - 无需预览，输入即渲染：编辑器直接显示渲染后的富文本效果
   - 所见即所得编辑体验：输入Markdown语法自动转换为格式
   - 支持所有Markdown元素：标题、列表、引用、代码块、表格等
   - 实时字数统计和保存状态显示

2. **选中文字工具栏（高亮、评论等）**
   - 选中文字后自动弹出浮动工具栏
   - **高亮功能**：支持多种颜色选择（黄色、绿色、蓝色、粉色、紫色）
   - **下划线功能**：支持多种颜色下划线
   - **评论功能**：选中文字可直接添加评论，评论面板显示在右侧
   - **格式功能**：加粗、斜体、链接插入
   - 工具栏智能定位：根据选中位置自动调整显示位置
   - 颜色选择器：悬停显示颜色下拉菜单

3. **评论功能（与案例评论一致）**
   - 右侧评论面板：可折叠展开，显示所有评论
   - 评论创建：通过工具栏或评论面板添加
   - 评论列表：显示评论者、时间、内容
   - 评论回复：支持对评论进行回复
   - 评论删除：可删除自己发布的评论
   - 评论与正文关联：点击评论可定位到对应文本
   - 评论数量显示：在工具栏显示当前笔记的评论数

4. **编辑器交互优化**
   - 点击编辑器外部自动关闭工具栏
   - 支持键盘快捷键：Ctrl+B加粗、Ctrl+I斜体等
   - 编辑器区域自适应高度，支持滚动
   - 评论面板可拖拽调整宽度

#### UI设计

- 编辑器区域：白色背景，舒适的阅读体验
- 工具栏：毛玻璃效果，悬浮在选中文字上方
- 评论面板：右侧固定，宽度可调（默认280px）
- 高亮标记：半透明背景色，不影响文字阅读
- 整体风格与飞书云文档保持一致

---

## 2026-02-23

### 笔记库模块 - 完整重构（Zotero+飞书云文档风格）

#### 新增功能

1. **三栏布局设计（Zotero风格）**
   - 左侧：文件夹导航 + 标签筛选
   - 中间：笔记列表（卡片式预览）
   - 右侧：Markdown编辑器 + 实时预览

2. **文件夹管理系统**
   - 多级文件夹结构支持（无限层级）
   - 文件夹展开/折叠功能
   - 新建文件夹：点击"+"按钮创建
   - 重命名文件夹：悬停显示编辑按钮，就地编辑
   - 删除文件夹：确认后删除，笔记移至未分类
   - 文件夹侧边栏可折叠，节省空间

3. **标签管理系统**
   - 多标签分类支持
   - 标签颜色自定义
   - 点击标签快速筛选笔记
   - 标签显示在笔记卡片上

4. **笔记列表功能**
   - 卡片式布局展示笔记
   - 显示标题、摘要、更新时间
   - 显示关联标签和引用计数
   - 实时搜索过滤
   - 按更新时间排序

5. **Markdown编辑器（飞书云文档风格）**
   - 富文本工具栏：粗体、斜体、下划线、删除线
   - 标题层级：H1、H2、H3
   - 列表支持：无序列表、有序列表、待办事项
   - 引用块、代码块、表格插入
   - 图片、链接、案例引用插入
   - 实时预览模式（左右分屏）
   - 字数统计和保存状态显示

6. **双向链接引用**
   - 支持 `@案例名称` 语法引用案例
   - 支持 `@笔记标题` 语法引用笔记
   - 显示关联案例和笔记数量

7. **笔记管理功能**
   - 新建笔记：点击"新建笔记"按钮
   - 编辑笔记：点击笔记卡片进入编辑
   - 删除笔记：更多菜单中删除
   - 移动笔记：支持移动到不同文件夹
   - 分享功能：生成分享链接
   - 导出功能：导出Markdown格式

#### 技术实现

- 重构 `Notes.vue` 组件，实现三栏布局
- 使用递归组件渲染文件夹树
- 使用 `marked` 库渲染 Markdown 预览
- 使用 CSS Grid 和 Flexbox 实现响应式布局
- 实现文件夹的增删改查操作
- 实现标签的筛选和显示
- 添加自动保存和字数统计功能

#### UI设计

- 左侧文件夹栏：220px宽度，可折叠至48px
- 中间笔记列表：320px宽度，自适应扩展
- 右侧编辑器：剩余空间，支持分屏预览
- 整体风格与系统其他模块保持一致
- 使用 Element Plus 组件库
- 支持深色模式（跟随系统）

---

## 2026-02-23

### 新增笔记库功能

#### 新增功能

1. **笔记库页面**
   - 创建全新的笔记库页面组件
   - 支持 Markdown 格式的笔记内容
   - 卡片式布局展示笔记列表
   - 支持标签分类管理

2. **笔记管理功能**
   - 新建笔记：点击右下角浮动按钮创建
   - 编辑笔记：点击编辑按钮修改
   - 删除笔记：确认后删除
   - 标签管理：支持多标签和自定义标签

3. **导航集成**
   - 在主导航栏"单词库"下方添加"笔记库"入口
   - 使用 Notebook 图标
   - 路由路径为 `/notes`

#### 技术实现

- 创建 `Notes.vue` 页面组件
- 添加 `/notes` 路由配置
- 使用 `marked` 库渲染 Markdown
- 使用 Element Plus 的 Dialog、Form、Select 等组件

---

## 2026-02-23

### 导航项名称修改

#### 修改内容

1. **"词汇学习"改为"单词库"**
   - 修改路由配置中的标题
   - 侧边栏导航显示为"单词库"

#### 技术实现

- 修改 `router/index.js` 中 Vocabulary 路由的 `meta.title` 为"单词库"

---

## 2026-02-23

### 侧边栏导航项位置调整

#### 修改内容

1. **交换"闪卡复习"和"思维导图"位置**
   - "思维导图"从"我的学习"区域移到主导航区域
   - "闪卡复习"从主导航区域移到"我的学习"区域
   - 保持其他导航项不变

#### 技术实现

- 修改 `mainRoutes` 计算属性，将 `Flashcards` 替换为 `MindMap`
- 修改"我的学习"区域的导航链接，将思维导图改为闪卡复习
- 修改 `mainRoutes` 排序逻辑，确保导航项按指定顺序显示

---

## 2026-02-23

### 案例阅读器 - 评论点击定位正文

#### 新增功能

1. **点击评论头部定位正文**
   - 点击评论卡片头部（引用原文区域）时
   - 自动展开/收起评论内容
   - 同时自动滚动左侧正文到对应段落
   - 对应段落高亮显示（黄色背景闪烁）

#### 技术实现

- 在 `toggleCommentExpand` 方法中添加定位逻辑
- 通过 `comment.paragraphIndex` 获取对应段落索引
- 调用 `scrollToParagraph` 方法滚动并高亮段落

---

## 2026-02-23

### 案例阅读器 - 目录重命名与段落编辑增强

#### 新增功能

1. **目录项重命名**
   - 点击目录项的编辑图标进入重命名模式
   - 显示输入框，预填充当前标题
   - 支持 Enter 保存、ESC 取消、失焦自动保存
   - 编辑状态以蓝色边框和淡蓝色背景标识

2. **段落编辑增强**
   - 编辑模式下每段显示段落编号和删除按钮
   - 删除按钮悬停显示，点击删除当前段落
   - 至少保留一个段落，删除最后一个时提示警告

3. **回车插入新段落**
   - 编辑模式下按回车键在当前段落后插入新段落
   - 自动聚焦到新段落输入框
   - 光标定位到新段落开头

4. **删除键合并段落**
   - 空段落按删除键（Backspace）删除当前段落
   - 自动聚焦到上一段末尾
   - 光标定位到上一段末尾

#### 技术实现

- 使用 `ref` 数组管理段落输入框引用
- 使用 `nextTick` 确保 DOM 更新后聚焦
- 使用 `setSelectionRange` 控制光标位置
- 添加 `toc-editing` 类标识编辑状态样式

---

### 案例阅读器 - 评论回复与图片功能增强

#### 新增功能

1. **回复编辑和删除**
   - 回复项显示编辑和删除按钮（悬停显示）
   - 点击编辑进入编辑模式，显示输入框和保存/取消按钮
   - 点击删除弹出确认对话框，确认后删除回复
   - 编辑和删除操作有成功提示

2. **评论和回复支持图片**
   - 评论输入区域支持拖拽图片上传
   - 评论输入区域支持粘贴图片（Ctrl+V）
   - 图片上传后显示缩略图预览
   - 点击缩略图上的删除按钮可移除图片
   - 评论和回复都支持附带图片
   - 回复编辑时也支持添加/删除图片

3. **图片缩略图显示**
   - 评论和回复中的图片以 80x80px 缩略图显示
   - 缩略图使用 `object-fit: cover` 保持比例
   - 悬停时图片有轻微放大效果
   - 多张图片横向排列，自动换行

4. **点击查看全图**
   - 左键点击缩略图打开全屏查看器
   - 全屏查看器背景为半透明黑色
   - 点击图片或背景关闭查看器
   - 图片最大显示 90% 屏幕尺寸

5. **右键复制原图**
   - 右键点击缩略图显示上下文菜单
   - 菜单选项：复制图片、在新窗口打开
   - 使用 Clipboard API 复制图片到剪贴板
   - 复制成功/失败有提示消息

6. **回复编辑图片支持**
   - 回复编辑模式显示已有图片缩略图
   - 支持拖拽添加新图片
   - 支持粘贴添加新图片
   - 支持删除已有图片
   - 保存时同步更新图片

#### 技术实现

- 使用 `FileReader` 读取图片文件为 DataURL
- 使用 `drag` 和 `paste` 事件处理图片上传
- 使用动态创建 DOM 元素实现全屏图片查看器
- 使用 `ClipboardItem` 和 `Clipboard API` 复制图片
- 使用 `canvas` 作为复制图片的降级方案
- 回复编辑时复制原图片数组到编辑状态

---

### 案例阅读器 - 修复编辑模式段落显示问题

#### Bug 修复

1. **修复编辑模式下段落显示不完整**
   - 问题：编辑模式下使用 `displayParagraphs` 计算属性，导致段落数受限
   - 解决：编辑模式改用 `editableParagraphs` 响应式数组
   - 阅读模式保持使用 `displayParagraphs`

2. **模板结构优化**
   - 使用 `<template v-if="isEditing">` 区分编辑和阅读模式
   - 编辑模式使用 `editableParagraphs` 循环渲染
   - 阅读模式使用 `displayParagraphs` 循环渲染
   - 添加不同的 `key` 值避免缓存问题

#### 技术实现

- 使用 `v-if` 和 `v-else` 分离两种模式的渲染逻辑
- 编辑模式 key 使用 `'edit-' + index`
- 阅读模式 key 使用 `'read-' + index`

---

## 2026-02-23

### AI 助手 - 接入真实 AI API

#### 新增功能

1. **AI API 服务集成**
   - 接入 `https://hiapi.online/v1` API 端点
   - 支持 GPT-4o-mini 模型调用
   - 实现标准 OpenAI 格式的聊天 completions 接口

2. **AI 服务模块**
   - 创建 `src/services/ai.js` 服务文件
   - 封装 `sendChatMessage()` 方法发送聊天消息
   - 封装 `sendChatMessageStream()` 方法支持流式响应
   - 封装 `getModels()` 方法获取可用模型列表

3. **AI Store 重构**
   - 将模拟回复改为真实 API 调用
   - 添加 `isLoading` 状态管理
   - 添加 `error` 错误状态
   - 实现 `clearMessages()` 清空对话方法
   - 保留最近 10 条历史消息作为上下文

4. **AIAssistant 组件优化**
   - 使用 store 中的 `isLoading` 替代本地状态
   - 添加 `watch` 监听消息变化自动滚动
   - 优化发送消息逻辑，支持异步调用
   - 清空对话调用 store 方法

#### 技术实现

- 使用 Fetch API 发送 HTTP 请求
- 支持流式响应处理（SSE）
- 系统提示词设置为法律学习助手角色
- 自动处理 API 错误并显示友好提示

---

## 2026-02-23

### 案例阅读器 - 飞书式标注与评论交互重构

#### 新增功能

1. **飞书风格标注工具栏**
   - 选中文本后显示浮动工具栏，位置在选中文本上方
   - 工具栏包含：高亮、下划线、评论、笔记、翻译、牌组
   - 高亮按钮显示黄色预览块，下划线按钮显示蓝色下划线预览
   - 点击外部或取消选择时自动关闭工具栏

2. **文本高亮与下划线**
   - 高亮：黄色背景色（#ffeb3b），悬停时变暗
   - 下划线：蓝色下划线（#2196f3），悬停时显示淡蓝色背景
   - 支持跨段落文本选择和标记
   - 点击已标记文本可跳转到对应评论

3. **飞书风格评论卡片**
   - 评论卡片头部显示引用的原文（浅黄色背景 #fffbeb）
   - 原文显示引号图标和最多两行文本预览
   - 点击头部可展开/收起评论内容
   - 评论内容区域显示：用户头像、用户名、发布时间、评论内容
   - 支持点赞、回复、编辑、删除操作

4. **评论与文本双向关联**
   - 点击正文中的高亮/下划线文本，右侧评论面板自动展开并定位
   - 评论卡片高亮显示（蓝色边框）
   - 评论面板自动滚动到对应评论位置

5. **翻译悬浮框**
   - 点击翻译按钮，在选中文本下方显示翻译弹窗
   - 显示原文和译文两部分内容
   - 支持关闭弹窗

#### 技术实现

- 使用 Range API 获取选中文本的位置信息
- 使用 TreeWalker 计算文本在段落中的偏移量
- 高亮数据独立存储，支持多种标记类型和颜色
- 使用 v-html 渲染带高亮标记的段落文本
- 全局函数 handleHighlightClick 处理高亮文本点击事件
- 评论卡片使用展开/收起状态管理

---

### 案例阅读器 - 标注颜色选择

#### 新增功能

1. **高亮颜色选择**
   - 鼠标悬停"高亮"按钮自动弹出颜色选择菜单
   - 点击按钮直接添加黄色高亮（默认颜色）
   - 点击颜色选项直接添加对应颜色的高亮
   - 选择颜色后，图标颜色自动变为选中的颜色
   - 高亮效果使用半透明背景色

2. **下划线颜色选择**
   - 鼠标悬停"下划线"按钮自动弹出颜色选择菜单
   - 点击按钮直接添加红色下划线（默认颜色）
   - 点击颜色选项直接添加对应颜色的下划线
   - 选择颜色后，图标颜色自动变为选中的颜色
   - 下划线使用对应颜色的实线

3. **按钮位置调整**
   - "高亮"和"下划线"按钮移到"批注"和"翻译"之前
   - 更符合用户操作习惯

#### 技术实现

- 使用 Element Plus Dropdown 组件实现颜色选择
- 使用 ref 存储当前选中的颜色状态
- 标注数据新增 color 字段存储颜色信息
- 动态生成内联样式应用颜色
- 图标颜色通过 `:style` 绑定动态变化

4. **评论功能重构（参照飞书云文档）**
   - 将"批注"改名为"评论"
   - 评论列表显示用户头像、用户名、评论内容、时间
   - 支持回复评论，显示回复列表
   - 评论与文本高亮关联，点击可跳转
   - 时间显示优化：刚刚、X分钟前、X小时前、X天前
   - **评论输入改为右侧直接添加**，不再使用弹窗对话框
   - **添加评论时，文字下方显示浅黄色下划线标注**
   - **支持添加图片和文件附件**，图片显示缩略图，其他文件显示图标
   - **点击左侧评论标注**，右侧自动滚动到对应评论并高亮动画
   - **点击右侧评论项**，左侧对应文本高亮并闪烁提示
   - **悬停评论项时，左侧对应文本高亮显示**
   - **评论支持编辑功能**，可修改内容和附件
   - **点击图片可查看原图**（在新窗口打开）
   - **回复支持编辑、删除、上传图片和文件**
   - **点击高亮/下划线标注**，右上角显示删除按钮，点击即可删除
   - **评论文本区域视觉优化**：非悬停状态仅显示浅黄色下划线，无任何高亮效果
   - **评论输入状态优化**：输入框为空时，下划线自动隐藏；输入内容后下划线显示

5. **标注叠加显示**
   - 支持在同一文本位置同时应用多个下划线和高亮标记
   - 高亮和下划线独立显示，样式叠加
   - 使用扫描线算法处理重叠的标注区域
   - 添加 HTML 转义防止 XSS 攻击

6. **删除功能**
   - 评论项悬停显示更多操作按钮（回复、删除）
   - 删除操作有确认对话框，防止误操作
   - 删除后有 ElMessage 提示反馈

---

### 案例库模块 - 文件夹功能增强

#### 新增功能

1. **左侧文件夹目录**
   - 新增"案例分类"侧边栏，位于案例库页面左侧
   - 默认文件夹包括：全部、宪法、刑法、合同法、侵权法、证据法
   - 每个文件夹显示对应的案例数量
   - 点击文件夹可筛选对应分类的案例

2. **无弹窗新建文件夹**
   - 点击"+"按钮或"新建文件夹"按钮，直接在列表末尾添加待命名文件夹
   - 新文件夹自动进入编辑状态，显示输入框
   - 支持Enter确认、ESC取消、失去焦点自动保存
   - 新文件夹以绿色虚线边框标识

3. **无弹窗重命名**
   - 鼠标悬停文件夹显示编辑按钮
   - 点击编辑按钮进入就地编辑模式
   - 支持Enter保存、ESC取消
   - 编辑状态以淡蓝色背景标识

4. **拖拽排序**
   - 文件夹左侧显示拖拽手柄（⋮⋮）
   - 支持拖拽调整文件夹顺序
   - "全部"文件夹固定在顶部，不可拖拽
   - 拖拽时有视觉反馈（半透明、旋转效果）

#### 技术实现

- 使用 `vuedraggable` 实现拖拽排序功能
- 使用 Vue 3 Composition API 管理文件夹状态
- 实现文件夹与案例分类的自动映射
- 添加响应式设计，支持移动端适配

#### UI优化

- 选中文件夹有高亮显示（红色边框）
- 操作按钮悬停显示
- 拖拽动画流畅
- 新建/编辑状态视觉区分明显

---

## 历史更新

### 案例库模块 - 导入功能增强

#### 新增功能

1. **"去查找"按钮**
   - 在导入案例的"剪贴板"标签页中新增"去查找"按钮
   - 点击打开案例查找资源面板

2. **案例查找资源面板**
   - 右侧滑出抽屉式面板
   - 分类展示权威法律数据库链接：
     - 免费权威平台（BAILII、CommonLII、AustLII、CanLII、NZLII、Singapore Law Watch、Oyez、CourtListener、FindLaw）
     - 付费专业数据库（Westlaw、LexisNexis、Bloomberg Law、LawNet、Westlaw AU）
   - 可折叠的章节设计
   - 使用建议时间线

#### UI优化

- 链接卡片展示（名称、标签、URL、描述）
- 外部链接安全提示
- 响应式布局适配
