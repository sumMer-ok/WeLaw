# EnofLaw 更新日志

## 2026-02-23

### 案例阅读器 - 评论点击定位正文

#### 新增功能

1. **点击评论头部定位正文**
   - 点击评论卡片头部（引用原文区域）时
   - 自动展开/收起评论内容
   - 同时自动滚动左侧正文到对应段落
   - 对应段落高亮显示（黄色背景闪烁）

#### 技术实现

- 在 `toggleCommentExpand` 方法中添加定位逻辑
- 通过 `comment.paragraphIndex` 获取对应段落索引
- 调用 `scrollToParagraph` 方法滚动并高亮段落

---

## 2026-02-23

### 案例阅读器 - 目录重命名与段落编辑增强

#### 新增功能

1. **目录项重命名**
   - 点击目录项的编辑图标进入重命名模式
   - 显示输入框，预填充当前标题
   - 支持 Enter 保存、ESC 取消、失焦自动保存
   - 编辑状态以蓝色边框和淡蓝色背景标识

2. **段落编辑增强**
   - 编辑模式下每段显示段落编号和删除按钮
   - 删除按钮悬停显示，点击删除当前段落
   - 至少保留一个段落，删除最后一个时提示警告

3. **回车插入新段落**
   - 编辑模式下按回车键在当前段落后插入新段落
   - 自动聚焦到新段落输入框
   - 光标定位到新段落开头

4. **删除键合并段落**
   - 空段落按删除键（Backspace）删除当前段落
   - 自动聚焦到上一段末尾
   - 光标定位到上一段末尾

#### 技术实现

- 使用 `ref` 数组管理段落输入框引用
- 使用 `nextTick` 确保 DOM 更新后聚焦
- 使用 `setSelectionRange` 控制光标位置
- 添加 `toc-editing` 类标识编辑状态样式

---

### 案例阅读器 - 评论回复与图片功能增强

#### 新增功能

1. **回复编辑和删除**
   - 回复项显示编辑和删除按钮（悬停显示）
   - 点击编辑进入编辑模式，显示输入框和保存/取消按钮
   - 点击删除弹出确认对话框，确认后删除回复
   - 编辑和删除操作有成功提示

2. **评论和回复支持图片**
   - 评论输入区域支持拖拽图片上传
   - 评论输入区域支持粘贴图片（Ctrl+V）
   - 图片上传后显示缩略图预览
   - 点击缩略图上的删除按钮可移除图片
   - 评论和回复都支持附带图片
   - 回复编辑时也支持添加/删除图片

3. **图片缩略图显示**
   - 评论和回复中的图片以 80x80px 缩略图显示
   - 缩略图使用 `object-fit: cover` 保持比例
   - 悬停时图片有轻微放大效果
   - 多张图片横向排列，自动换行

4. **点击查看全图**
   - 左键点击缩略图打开全屏查看器
   - 全屏查看器背景为半透明黑色
   - 点击图片或背景关闭查看器
   - 图片最大显示 90% 屏幕尺寸

5. **右键复制原图**
   - 右键点击缩略图显示上下文菜单
   - 菜单选项：复制图片、在新窗口打开
   - 使用 Clipboard API 复制图片到剪贴板
   - 复制成功/失败有提示消息

6. **回复编辑图片支持**
   - 回复编辑模式显示已有图片缩略图
   - 支持拖拽添加新图片
   - 支持粘贴添加新图片
   - 支持删除已有图片
   - 保存时同步更新图片

#### 技术实现

- 使用 `FileReader` 读取图片文件为 DataURL
- 使用 `drag` 和 `paste` 事件处理图片上传
- 使用动态创建 DOM 元素实现全屏图片查看器
- 使用 `ClipboardItem` 和 `Clipboard API` 复制图片
- 使用 `canvas` 作为复制图片的降级方案
- 回复编辑时复制原图片数组到编辑状态

---

### 案例阅读器 - 修复编辑模式段落显示问题

#### Bug 修复

1. **修复编辑模式下段落显示不完整**
   - 问题：编辑模式下使用 `displayParagraphs` 计算属性，导致段落数受限
   - 解决：编辑模式改用 `editableParagraphs` 响应式数组
   - 阅读模式保持使用 `displayParagraphs`

2. **模板结构优化**
   - 使用 `<template v-if="isEditing">` 区分编辑和阅读模式
   - 编辑模式使用 `editableParagraphs` 循环渲染
   - 阅读模式使用 `displayParagraphs` 循环渲染
   - 添加不同的 `key` 值避免缓存问题

#### 技术实现

- 使用 `v-if` 和 `v-else` 分离两种模式的渲染逻辑
- 编辑模式 key 使用 `'edit-' + index`
- 阅读模式 key 使用 `'read-' + index`

---

## 2026-02-23

### AI 助手 - 接入真实 AI API

#### 新增功能

1. **AI API 服务集成**
   - 接入 `https://hiapi.online/v1` API 端点
   - 支持 GPT-4o-mini 模型调用
   - 实现标准 OpenAI 格式的聊天 completions 接口

2. **AI 服务模块**
   - 创建 `src/services/ai.js` 服务文件
   - 封装 `sendChatMessage()` 方法发送聊天消息
   - 封装 `sendChatMessageStream()` 方法支持流式响应
   - 封装 `getModels()` 方法获取可用模型列表

3. **AI Store 重构**
   - 将模拟回复改为真实 API 调用
   - 添加 `isLoading` 状态管理
   - 添加 `error` 错误状态
   - 实现 `clearMessages()` 清空对话方法
   - 保留最近 10 条历史消息作为上下文

4. **AIAssistant 组件优化**
   - 使用 store 中的 `isLoading` 替代本地状态
   - 添加 `watch` 监听消息变化自动滚动
   - 优化发送消息逻辑，支持异步调用
   - 清空对话调用 store 方法

#### 技术实现

- 使用 Fetch API 发送 HTTP 请求
- 支持流式响应处理（SSE）
- 系统提示词设置为法律学习助手角色
- 自动处理 API 错误并显示友好提示

---

## 2026-02-23

### 案例阅读器 - 飞书式标注与评论交互重构

#### 新增功能

1. **飞书风格标注工具栏**
   - 选中文本后显示浮动工具栏，位置在选中文本上方
   - 工具栏包含：高亮、下划线、评论、笔记、翻译、牌组
   - 高亮按钮显示黄色预览块，下划线按钮显示蓝色下划线预览
   - 点击外部或取消选择时自动关闭工具栏

2. **文本高亮与下划线**
   - 高亮：黄色背景色（#ffeb3b），悬停时变暗
   - 下划线：蓝色下划线（#2196f3），悬停时显示淡蓝色背景
   - 支持跨段落文本选择和标记
   - 点击已标记文本可跳转到对应评论

3. **飞书风格评论卡片**
   - 评论卡片头部显示引用的原文（浅黄色背景 #fffbeb）
   - 原文显示引号图标和最多两行文本预览
   - 点击头部可展开/收起评论内容
   - 评论内容区域显示：用户头像、用户名、发布时间、评论内容
   - 支持点赞、回复、编辑、删除操作

4. **评论与文本双向关联**
   - 点击正文中的高亮/下划线文本，右侧评论面板自动展开并定位
   - 评论卡片高亮显示（蓝色边框）
   - 评论面板自动滚动到对应评论位置

5. **翻译悬浮框**
   - 点击翻译按钮，在选中文本下方显示翻译弹窗
   - 显示原文和译文两部分内容
   - 支持关闭弹窗

#### 技术实现

- 使用 Range API 获取选中文本的位置信息
- 使用 TreeWalker 计算文本在段落中的偏移量
- 高亮数据独立存储，支持多种标记类型和颜色
- 使用 v-html 渲染带高亮标记的段落文本
- 全局函数 handleHighlightClick 处理高亮文本点击事件
- 评论卡片使用展开/收起状态管理

---

### 案例阅读器 - 标注颜色选择

#### 新增功能

1. **高亮颜色选择**
   - 鼠标悬停"高亮"按钮自动弹出颜色选择菜单
   - 点击按钮直接添加黄色高亮（默认颜色）
   - 点击颜色选项直接添加对应颜色的高亮
   - 选择颜色后，图标颜色自动变为选中的颜色
   - 高亮效果使用半透明背景色

2. **下划线颜色选择**
   - 鼠标悬停"下划线"按钮自动弹出颜色选择菜单
   - 点击按钮直接添加红色下划线（默认颜色）
   - 点击颜色选项直接添加对应颜色的下划线
   - 选择颜色后，图标颜色自动变为选中的颜色
   - 下划线使用对应颜色的实线

3. **按钮位置调整**
   - "高亮"和"下划线"按钮移到"批注"和"翻译"之前
   - 更符合用户操作习惯

#### 技术实现

- 使用 Element Plus Dropdown 组件实现颜色选择
- 使用 ref 存储当前选中的颜色状态
- 标注数据新增 color 字段存储颜色信息
- 动态生成内联样式应用颜色
- 图标颜色通过 `:style` 绑定动态变化

4. **评论功能重构（参照飞书云文档）**
   - 将"批注"改名为"评论"
   - 评论列表显示用户头像、用户名、评论内容、时间
   - 支持回复评论，显示回复列表
   - 评论与文本高亮关联，点击可跳转
   - 时间显示优化：刚刚、X分钟前、X小时前、X天前
   - **评论输入改为右侧直接添加**，不再使用弹窗对话框
   - **添加评论时，文字下方显示浅黄色下划线标注**
   - **支持添加图片和文件附件**，图片显示缩略图，其他文件显示图标
   - **点击左侧评论标注**，右侧自动滚动到对应评论并高亮动画
   - **点击右侧评论项**，左侧对应文本高亮并闪烁提示
   - **悬停评论项时，左侧对应文本高亮显示**
   - **评论支持编辑功能**，可修改内容和附件
   - **点击图片可查看原图**（在新窗口打开）
   - **回复支持编辑、删除、上传图片和文件**
   - **点击高亮/下划线标注**，右上角显示删除按钮，点击即可删除
   - **评论文本区域视觉优化**：非悬停状态仅显示浅黄色下划线，无任何高亮效果
   - **评论输入状态优化**：输入框为空时，下划线自动隐藏；输入内容后下划线显示

5. **标注叠加显示**
   - 支持在同一文本位置同时应用多个下划线和高亮标记
   - 高亮和下划线独立显示，样式叠加
   - 使用扫描线算法处理重叠的标注区域
   - 添加 HTML 转义防止 XSS 攻击

6. **删除功能**
   - 评论项悬停显示更多操作按钮（回复、删除）
   - 删除操作有确认对话框，防止误操作
   - 删除后有 ElMessage 提示反馈

---

### 案例库模块 - 文件夹功能增强

#### 新增功能

1. **左侧文件夹目录**
   - 新增"案例分类"侧边栏，位于案例库页面左侧
   - 默认文件夹包括：全部、宪法、刑法、合同法、侵权法、证据法
   - 每个文件夹显示对应的案例数量
   - 点击文件夹可筛选对应分类的案例

2. **无弹窗新建文件夹**
   - 点击"+"按钮或"新建文件夹"按钮，直接在列表末尾添加待命名文件夹
   - 新文件夹自动进入编辑状态，显示输入框
   - 支持Enter确认、ESC取消、失去焦点自动保存
   - 新文件夹以绿色虚线边框标识

3. **无弹窗重命名**
   - 鼠标悬停文件夹显示编辑按钮
   - 点击编辑按钮进入就地编辑模式
   - 支持Enter保存、ESC取消
   - 编辑状态以淡蓝色背景标识

4. **拖拽排序**
   - 文件夹左侧显示拖拽手柄（⋮⋮）
   - 支持拖拽调整文件夹顺序
   - "全部"文件夹固定在顶部，不可拖拽
   - 拖拽时有视觉反馈（半透明、旋转效果）

#### 技术实现

- 使用 `vuedraggable` 实现拖拽排序功能
- 使用 Vue 3 Composition API 管理文件夹状态
- 实现文件夹与案例分类的自动映射
- 添加响应式设计，支持移动端适配

#### UI优化

- 选中文件夹有高亮显示（红色边框）
- 操作按钮悬停显示
- 拖拽动画流畅
- 新建/编辑状态视觉区分明显

---

## 历史更新

### 案例库模块 - 导入功能增强

#### 新增功能

1. **"去查找"按钮**
   - 在导入案例的"剪贴板"标签页中新增"去查找"按钮
   - 点击打开案例查找资源面板

2. **案例查找资源面板**
   - 右侧滑出抽屉式面板
   - 分类展示权威法律数据库链接：
     - 免费权威平台（BAILII、CommonLII、AustLII、CanLII、NZLII、Singapore Law Watch、Oyez、CourtListener、FindLaw）
     - 付费专业数据库（Westlaw、LexisNexis、Bloomberg Law、LawNet、Westlaw AU）
   - 可折叠的章节设计
   - 使用建议时间线

#### UI优化

- 链接卡片展示（名称、标签、URL、描述）
- 外部链接安全提示
- 响应式布局适配
